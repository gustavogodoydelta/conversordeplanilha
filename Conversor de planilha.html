<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conversor de planilhas em PDF</title>

  <!-- Feather Icons -->
  <script src="https://unpkg.com/feather-icons"></script>
  <!-- SheetJS -->
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  <!-- jsPDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <!-- jsPDF-AutoTable -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.25/dist/jspdf.plugin.autotable.min.js"></script>

  <style>
    * { box-sizing: border-box; }
    body, html {
      margin: 0; padding: 0;
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #1A1A1A;
      color: #FFFFFF;
      overflow-x: hidden;
    }
    .background-animado {
      position: fixed;
      inset: 0;
      background: linear-gradient(135deg, #00d4ff, #8b00ff);
      opacity: 0.05;
      animation: waveAnim 20s linear infinite;
      filter: blur(40px);
      z-index: -1;
    }
    @keyframes waveAnim {
      0% {background-position: 0 0;}
      100% {background-position: 1000px 0;}
    }
    main.container-glass {
      max-width: 900px;
      margin: 2rem auto 4rem;
      padding: 2rem;
      backdrop-filter: blur(14px) saturate(180%) brightness(100%) contrast(90%);
      background: rgba(255, 255, 255, 0.15);
      border-radius: 20px;
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 30px rgba(0,0,0,0.1);
      color: #fff;
      user-select: none;
      transition: all 0.3s ease;
    }
    main.container-glass h1 {
      font-weight: 800;
      margin-bottom: 0.3rem;
      text-align: center;
    }
    main.container-glass p.creditos {
      margin-top: 0;
      font-size: 0.85rem;
      font-weight: 400;
      color: #CCCCCC;
      text-align: center;
      user-select: text;
    }
    .controls-card {
      margin-top: 1.8rem;
      display: flex;
      gap: 1rem;
      justify-content: center;
      flex-wrap: wrap;
      align-items: center;
    }
    input[type="file"] {
      color: transparent;
      width: 200px;
      position: relative;
      overflow: hidden;
      cursor: pointer;
      height: 40px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.2);
      background: #F3F4F6; /* Botão claro */
      box-shadow: none;
      font-weight: 600;
      font-size: 0.9rem;
      opacity: 0.9;
      transition: opacity 0.3s ease;
    }
    input[type="file"]::before {
      content: "Selecionar arquivos";
      color: #222222;
      position: absolute;
      left: 10px;
      top: 9px;
      pointer-events: none;
      font-weight: 600;
      font-size: 0.9rem;
      text-shadow: none;
    }
    input[type="file"]:hover {
      opacity: 1;
    }
    input[type="file"]:focus {
      outline: none;
      box-shadow: 0 0 0 2px #A0A0A0;
    }
    input[type="file"]::-webkit-file-upload-button {
      visibility: hidden;
    }
    select#orientation {
      border-radius: 12px;
      padding: 10px 16px;
      border: none;
      outline: none;
      font-weight: 600;
      font-size: 1rem;
      background: #F3F4F6; /* Claro */
      color: #111111; /* Preto no dropdown */
      cursor: pointer;
      box-shadow: none;
      transition: background 0.3s ease;
      user-select: none;
      min-width: 110px;
    }
    select#orientation option {
      color: #111111; /* Preto nas opções */
      background: #FFF;
    }
    select#orientation:hover,
    select#orientation:focus {
      background: #e6e8eb;
    }
    button#convert-btn {
      background: #F3F4F6; /* Botão claro */
      border: none;
      border-radius: 15px;
      padding: 12px 26px;
      color: #111111; /* Texto escuro */
      font-weight: 700;
      font-size: 1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: none;
      transition: background 0.2s, color 0.2s;
      user-select: none;
    }
    button#convert-btn:hover,
    button#convert-btn:active {
      background: #E5E7EB;
      color: #111111;
      box-shadow: none;
      filter: none;
    }
    #docs-list {
      margin-top: 2rem;
      display: grid;
      grid-template-columns: repeat(auto-fill,minmax(280px,1fr));
      gap: 1.2rem;
    }
    .doc-card {
      background: rgba(255,255,255,0.15);
      border-radius: 12px;
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
      padding: 14px 20px;
      color: inherit;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      user-select: text;
      transition: box-shadow 0.3s ease;
    }
    .doc-card:hover {
      box-shadow: 0 6px 40px rgba(130,0,255,0.45);
    }
    .doc-filename {
      font-weight: 700;
      font-size: 1.1rem;
      overflow-wrap: break-word;
      word-break: break-all;
    }
    .doc-status {
      font-size: 0.88rem;
      color: inherit;
    }
    svg.feather {
      stroke-width: 2.2;
      transition: all 0.3s ease;
      user-select: none;
    }
    button#convert-btn svg.feather {
      stroke: #111111;
      width: 18px; height: 18px;
    }
  </style>
</head>
<body>
  <div class="background-animado"></div>
  <main class="container-glass" role="main" aria-label="Conversor de planilhas em PDF">
    <h1>Conversor de planilhas em PDF</h1>
    <p class="creditos">Criado por Gustavo Godoy Alevado (gustavoalevado@pjc.mt.gov.br)</p>
    <div class="controls-card" role="region" aria-label="Controles de entrada e orientação">
      <input type="file" id="file-input" accept=".xls,.xlsx" multiple aria-label="Selecionar arquivos XLS ou XLSX"/>
      <select id="orientation" aria-label="Selecionar orientação da página">
        <option value="portrait">Retrato</option>
        <option value="landscape">Paisagem</option>
      </select>
      <button id="convert-btn" aria-live="polite" aria-busy="false">
        <i data-feather="file-plus"></i> Converter para PDF
      </button>
    </div>
    <section id="docs-list" aria-live="polite" aria-atomic="true" aria-relevant="additions"></section>
  </main>
  <script>
    (() => {
      feather.replace();
      const { jsPDF } = window.jspdf;
      const fileInput = document.getElementById('file-input');
      const orientationSelect = document.getElementById('orientation');
      const convertBtn = document.getElementById('convert-btn');
      const docsList = document.getElementById('docs-list');
      let selectedFiles = [];
      function sanitizeFilename(name){
        return name.replace(/[^a-z0-9_\-\.]/gi, '_');
      }
      function addDocCard(file) {
        const card = document.createElement('article');
        card.className = 'doc-card';
        card.id = `doc-${sanitizeFilename(file.name)}`;
        const filenameEl = document.createElement('h2');
        filenameEl.className = 'doc-filename';
        filenameEl.textContent = file.name;
        const statusEl = document.createElement('p');
        statusEl.className = 'doc-status';
        statusEl.textContent = 'Pronto para converter';
        card.appendChild(filenameEl);
        card.appendChild(statusEl);
        docsList.appendChild(card);
        return { card, statusEl };
      }
      function setStatus(cardRef, text, isError = false) {
        cardRef.statusEl.textContent = text;
        cardRef.card.style.color = isError ? '#ff6b6b' : '';
      }
      function updateSelectedFiles(files) {
        selectedFiles = Array.from(files);
        docsList.innerHTML = '';
        selectedFiles.forEach(f => addDocCard(f));
      }
      fileInput.addEventListener('change', e => {
        updateSelectedFiles(e.target.files);
      });
      function calcMaxColumnWidths(sheetData) {
        const colWidths = [];
        sheetData.forEach(row => {
          row.forEach((cell, colIdx) => {
            let content = cell !== null && cell !== undefined ? String(cell) : '';
            if (!colWidths[colIdx]) colWidths[colIdx] = 0;
            colWidths[colIdx] = Math.max(colWidths[colIdx], content.length);
          });
        });
        return colWidths;
      }
      function mapLengthToPdfUnits(charCount) {
        const averageCharWidthPt = 6;
        return charCount * averageCharWidthPt;
      }
      async function addSheetToPdf(doc, sheetName, sheetData, orientation, isLastSheet) {
        doc.setTextColor(0, 0, 0);
        doc.setFontSize(14);
        doc.setFont('helvetica', 'bold');
        const marginLeft = 10;
        const marginTop = 16;
        const pageWidth = doc.internal.pageSize.getWidth();
        doc.text(sheetName, marginLeft, marginTop);
        const cleanData = sheetData.map(row => row.map(cell => cell === undefined ? '' : String(cell)));
        const colCharWidths = calcMaxColumnWidths(cleanData);
        const colCount = colCharWidths.length;
        let totalWidth = colCharWidths.reduce((acc, count) => acc + mapLengthToPdfUnits(count), 0);
        let maxTableWidth = pageWidth - marginLeft * 2;
        let scale = (totalWidth > maxTableWidth) ? (maxTableWidth / totalWidth) : 1;
        const colWidthsPt = colCharWidths.map(cw => mapLengthToPdfUnits(cw) * scale);
        const colStyles = {};
        for(let i = 0; i < colCount; i++){
          colStyles[i] = { cellWidth: colWidthsPt[i], halign: 'left' };
        }
        const header = cleanData.length > 0 ? cleanData[0] : [];
        const body = cleanData.length > 1 ? cleanData.slice(1) : [];
        const startY = marginTop + 8;
        await doc.autoTable({
          head: [header],
          body: body,
          startY: startY,
          margin: { left: marginLeft, right: marginLeft },
          tableWidth: maxTableWidth,
          columnStyles: colStyles,
          styles: {
            fontSize: 8,
            textColor: [0, 0, 0],        // preto
            halign: 'left',
            fillColor: null,
            overflow: 'linebreak',
            lineColor: [0, 0, 0],        // bordas pretas
            lineWidth: 0.2
          },
          headStyles: {
            fillColor: null,
            textColor: [0, 0, 0],        // preto no cabeçalho
            fontStyle: 'bold',
            lineColor: [0, 0, 0],
            lineWidth: 0.3
          },
          alternateRowStyles: {
            fillColor: null
          }
        });
        if(!isLastSheet) doc.addPage();
      }
      async function convertFile(file, orientation) {
        const cardRef = addDocCard(file);
        try {
          setStatus(cardRef, 'Lendo arquivo...');
          const data = await readFileAsArrayBuffer(file);
          const workbook = XLSX.read(data, { type: 'array' });
          setStatus(cardRef, `Convertendo ${workbook.SheetNames.length} abas...`);
          const doc = new jsPDF({
            orientation: orientation,
            unit: 'pt',
            format: 'a4',
            putOnlyUsedFonts:true
          });
          let sheetsCount = workbook.SheetNames.length;
          for(let i = 0; i < sheetsCount; i++){
            const sheetName = workbook.SheetNames[i];
            const worksheet = workbook.Sheets[sheetName];
            const sheetData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false });
            await addSheetToPdf(doc, sheetName, sheetData, orientation, i === sheetsCount - 1);
          }
          setStatus(cardRef, 'Preparando download do PDF...');
          const baseName = file.name.replace(/\.(xls|xlsx)$/i, '');
          const pdfName = baseName + '.pdf';
          const pdfBlob = doc.output('blob');
          triggerDownload(pdfBlob, pdfName);
          setStatus(cardRef, 'Conversão concluída com sucesso!');
        } catch(err) {
          setStatus(cardRef, 'Erro na conversão do arquivo', true);
          alert(`Erro ao processar o arquivo ${file.name}:\n${err.message || err}`);
        }
      }
      function readFileAsArrayBuffer(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.onerror = () => reject(reader.error);
          reader.readAsArrayBuffer(file);
        });
      }
      function triggerDownload(blob, filename) {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        setTimeout(() => {
          URL.revokeObjectURL(url);
          document.body.removeChild(a);
        }, 100);
      }
      convertBtn.addEventListener('click', async () => {
        if(selectedFiles.length === 0){
          alert('Por favor, selecione pelo menos um arquivo XLS ou XLSX para converter.');
          return;
        }
        convertBtn.setAttribute('aria-busy', 'true');
        convertBtn.disabled = true;
        const orientation = orientationSelect.value;
        for(let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          await convertFile(file, orientation);
        }
        convertBtn.setAttribute('aria-busy', 'false');
        convertBtn.disabled = false;
      });
    })();
  </script>
</body>
</html>